<!DOCTYPE html>
<html>
<body>
	<div class="col-6 offset-3">
        	<video id="videoElement_live" style="width: 100%; height:100%;" controls autoplay muted></video>
        </div>
</body>
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="EEN.MediaPlayer.js"></script>
<script>

$(document).ready(function() {

	var flvjs = EEN.MediaPlayer.flvjs;
	var playing_ts = DtoS(new Date());
        var videoElementLive = document.getElementById('videoElement_live');


	function loadPlayer(auth_key, domain, camera_id, start_ts, end_ts) {
            if (flvjs.isSupported()) {
                //videoElementLive = document.getElementById('videoElement_live');
                var config = new EEN.MediaPlayer.MediaItem(camera_id);
                config.setAuthKey(auth_key);
                config.setDomain(domain);
                config.setStartTime(start_ts);
                config.setEndTime(end_ts);
                EEN.MediaPlayer.startPlayback(config, videoElementLive);
		var poster = 'https://' + domain + '/asset/asset/image.jpeg?id=' + camera_id +'&asset_class=all&timestamp=' + start_ts + '&A=' + auth_key;
		videoElementLive.poster = poster;
            } else {
		console.log("browser does not support this");
		}
        }



	$.getJSON('https://streamer.een.cloud', function(data) {

		// Start with declairing the basic variables
		account_sub_domain = data.active_brand_subdomain;
		account_id = data.account;
		camera_id = data.cameras[0].id
		auth_key = data.auth_key


		// Build the subscription string
		data = {"cameras": {}};
		data.cameras[camera_id] = {"resource": ["event"], "event": ["PRTH"]}


		// Build the WebSocket connection URL
		connection_url = [
			"wss://", 
			account_sub_domain,
			".eagleeyenetworks.com",
			"/api/v2/Device/",
			account_id,
			"/Events?A=",
			auth_key
		].join('');


		// make the WebSocket connection
		socket = new WebSocket(connection_url);


		// when the socket opens, register the subscriptions
		socket.addEventListener('open', function(event) {
			console.log('socket opened');
			socket.send(JSON.stringify(data));
			
		});

		// for every message received, parse the data into an object and update the image on the page
		// send an acknowledgement that you are ready for the next image
		socket.addEventListener('message', function(event) {
			json = JSON.parse(event.data);
			prth_ts = json['data'][camera_id]['event']['PRTH']['timestamp']
			
			start_ts = DtoS(StoD(prth_ts) - 10000);
			end_ts = DtoS(StoD(prth_ts) + 20000);


			// look at the time stamps to see if the thumbnail event is inside of a existing video request

			if( playing_ts > prth_ts ) {
				console.log("skipping video");
				console.log('PRTH: ' + prth_ts);
				console.log('playing_ts: ' + playing_ts);
			} else {
				console.log("loading video");
				console.log('PRTH: ' + prth_ts);
				console.log('playing_ts: ' + playing_ts);
				console.log('start_ts: ' + start_ts);
				console.log('end_ts: ' + end_ts);
				loadPlayer(auth_key, account_sub_domain+'.eagleeyenetworks.com', camera_id, start_ts, end_ts); 
			}

			playing_ts = end_ts

		});

		// handle the close event
		socket.addEventListener('close', function(event) {
			console.log('socket closed')
			socket = new WebSocket(connection_url);
		});

		// handle any errors
		socket.addEventListener('error', function(event) {
			console.log('socket error ', event);
		});

	});


function _padTo2Digits(num) {
    return (((num < 10) ? '0' : '') + num);
}


function DtoS(epoch_time) {
    var yy, mm, dd, hr, mn, sc, ms, timecode, jstime;
        jstime = new Date(epoch_time);
        yy = jstime.getUTCFullYear();
        mm = _padTo2Digits(1 + jstime.getUTCMonth());
        dd = _padTo2Digits(jstime.getUTCDate());
        hr = _padTo2Digits(jstime.getUTCHours());
        mn = _padTo2Digits(jstime.getUTCMinutes());
        sc = _padTo2Digits(jstime.getUTCSeconds());
        ms = jstime.getUTCMilliseconds();
        if (ms < 10) {
            ms = '00' + ms;
        } else if (ms < 100) {
            ms = '0' + ms;
        }
        timecode = yy + mm + dd + hr + mn + sc + '.' + ms;
        return timecode;
}

function StoD(timecode) {
    if(timecode) {
        var yy, mm, dd, hr, mn, sc, ms, jstime;
        yy = parseInt(timecode.substring(0, 4), 10);
        mm = parseInt(timecode.substring(4, 6), 10);
        dd = parseInt(timecode.substring(6, 8), 10);
        hr = parseInt(timecode.substring(8, 10), 10);
        mn = parseInt(timecode.substring(10, 12), 10);
        sc = parseInt(timecode.substring(12, 14), 10);
        ms = parseInt(timecode.substring(15), 10);
        jstime = new Date(Date.UTC(yy, mm - 1, dd, hr, mn, sc, ms));
        return jstime.valueOf();
    }
}





});

</script>
</html>
