<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <title>Polling Example with Websockets - Eagle Eye Networks API</title>
    <style>
        
        .preview_img {
            width: 320px;
            height: 180px;
        }

        img {
            width: 100%;
            border: grey solid thin;
        }

        body {
          padding-top: 5rem;
        }

        .starter-template {
          padding: 3rem 1.5rem;
          text-align: center;
        }

        .row {
            padding-top: 10px;
            padding-bottom: 20px;
        }

        h2 {
            border-bottom: thick linen solid;
        }


    </style>
</head>
<body>
    <main role="main" class="container-fluid">
        <div class="container-fluid">
            <div class="row" id="camera_holder"></div>

            <div class="row">
                <div class="col-9 offset-1">
                    <h1>Polling Example with Websockets</h1>
                </div>
            </div>


            <div class="row">
                <div class="col-9 offset-1"> 
                    <p>
                       Continueing from an earlier <a href="/article-1.html">article</a>, we are going to show how to use the Eagle Eye Polling API with Websockets.
                    </p>
                    <p>
                        Websockets are a bidirectional HTTP connection that behaves like a traditional network socket.  It starts out as traditional HTTP Request but passes a header indicating that it would like to upgrade to a Websocket.  This is a common and well supported option for modern webapps.  It is more efficient than the previous polling example because it does not create and destroy the connection for every request. 
                    </p>
                    <p>
                        Most common programming languages has the ability to support websockets.  I will show two examples using Python and Node.js.  Both of there projects are available as examples.  They can be installed or run in their Docker containers.
                    </p>
                </div>
            </div>
            <div class="row">
                <div class="col-11 offset-1">
                    <h2>Getting Started</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-8 offset-1">       
                   <p>
                       The best place to start is with the <a href="https://apidocs.eagleeyenetworks.com/apidocs/#websocket-polling">API documentation</a>.  This explains the details of the HTP request, handshake, and other important caveats.
                    </p>
                    <p>
                        The Status Bitmask will be covered in a separate article, for now, I recommend focusing on the parsed status output returned by these examples.  The parsed status output matches the status labels used inside of the VMS.
                    </p>
                </div>
                <div class="col-3"></div>
            </div>
            <div class="row">
                <div class="col-11 offset-1">
                    <h2>Example 1: Python script</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-6 offset-1">       
                   <p>
                       This script with go through the steps of logging-in, getting devices, subscribing to the poll stream and parsing the status information.  The output is formated to give a human readable output that shows the status of camera on/off, camera internet online/offline, camera streaming, and camera recording.
                    </p>
                    <p>
                        The script will maintain the Websocket until it is interrupted.  To keep this example simple, I am not showing of to handle disconnections and errors.  In production, the script should handle erros and reconnect when needed.
                    </p>
                    <p>
                        You can download this script <a href="https://github.com/mcotton/EE-API-examples/blob/master/Listen_for_status_changes.py">here</a>.
                    </p>
                </div>
                <div class="col-5">
                    <img src="images/article-16-001.png">
                </div>
            </div>

            <div class="row">
                <div class="col-11 offset-1">
                    <h2>Example 2: Node.js </h2>
                </div>
            </div>
            <div class="row">
                <div class="col-6 offset-1">
                    <p>
                       This project subscribes to the Poll stream with Websockets, addes events that match the set criteria to a queue, and then it can be configured to do something in the `worker.js` file.  The most common use case is to have it call a webhook and pass the data to another service.  This project is intended to be a starting point and not an end-to-end example. 
                    </p>
                    <p>
                        Inside of `config.js` thre are several parameters that need to be configured.  The first is username, password, and API key.  After that, it is important to specify the events you want the script to listen for.  Listening for recording start/stop events can potentially cause a lot of events to be enqueued.
                    </p>
                    <p>
                        You can download this project <a href="https://github.com/mcotton/websocket2webhook">here</a>.
                </div>
                <div class="col-5">
                    <img src="images/article-16-002.png">
                </div>
            </div>

            <div class="row">
                <div class="col-11 offset-1">
                    <h2>Working with multiple sub-accounts</h2>
                </div>
            </div>
            <div class="row">
                <div class="col-9 offset-1">
                    <p>
                       If you login as a user at the dealer level, you will need to switch into a subaccount before you can access the devices for that subaccount.  You can do this by getting a <a href="https://apidocs.eagleeyenetworks.com/apidocs/#get-list-of-accounts">list of subaccounts</a> you have access to and then makeing a <a href="https://apidocs.eagleeyenetworks.com/apidocs/#switch-account">switch account</a> call.
                    </p>
                    <p>
                        Each sub-account will need a subscription to the poll stream for the devices in that account.  This means that you will need to manage having one websocket per subaccount.  This can be done through threads or by making the process capable of using multiple processes.
                    </p>
                    <P>
                        Maintaining a connect over the internet is going to experience interrrupts and the occasional dropped connection.  It is important that before going into production, these events are handled and connections are re-established.
                    </P>
                </div>
            </div>


            <div class="row">
                <div class="col-11 offset-1">
                    <h2>What else can we do with this?</h2>
                </div>
            </div>
            <div class="row">
                <div class="col-9 offset-1">
                    <p>
                       I hope that this is a helpful starting point as you explore this feature of the Eagle Eye API.  Getting real time information is key in many integrations and with these examples you should be able to quickly adapt them for your needs.  I hope you found this helpful.  If you have any questions please feel free to reach out to us at api_support@een.com
                    </p>
                
                </div>

            </div>
            
        </div>

    </main>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

</body>
</html>
