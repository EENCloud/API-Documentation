<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <title>Websocket Polling Example - Eagle Eye Networks API</title>
    <style>

        .preview_img {
            width: 320px;
            height: 180px;
        }

        img {
            width: 100%;
            border: grey solid thin;
        }

        body {
            padding-top: 5rem;
        }

        .starter-template {
            padding: 3rem 1.5rem;
            text-align: center;
        }

        .row {
            padding-top: 10px;
            padding-bottom: 20px;
        }

        h2 {
            border-bottom: thick linen solid;
        }

        table {
            width: 100%;
        }

        input {
            width:350px;
        }


    </style>
</head>
<body>
<main role="main" class="container-fluid">
    <div class="container-fluid">
        <div class="row" id="camera_holder"></div>

        <div class="row">
            <div class="col-9 offset-1">
	    	<h1>Websocket Polling Example</h1>
            </div>
        </div>


        <div class="row">
            <div class="col-9 offset-1">
                <p>
			This is a test page to demonstrate how to get realtime events through a websocket connection to the  Eagle Eye Networks <a href="https://apidocs.eagleeyenetworks.com/apidocs/#websocket-polling">Poll Stream endpoint</a>
                </p>
            </div>
        </div>
        <div class="row">
            <div class="col-11 offset-1">
                <h2>How do I get started?</h2>
            </div>
        </div>

        <div class="row">
            <div class="col-7 offset-1">
                <p>
                    We have already been using the HTML5 video player for video playback inside of the Eagle Eye VMS.  It has been the default option since the second half of 2019.  If you are embedding or linking to the video player page/history browser than you already have been using the HTML5 video player.
                </P>
			</div>
		</div>

		<div class="row">
			<div class="col-6 offset-1">
                <p>
                    Please supply a valid ESN and an auth_key that has access to view the video.
                </p>
                <p>
                <table>
                    <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>Account ID</td>
                        <td><input type="text" placeholder="Account ID" maxlength="8" style="form-control" id="1_account"></td>
                    </tr>
                    <tr>
                        <td>Camera ESN</td>
                        <td><input type="text" placeholder="Camera ESN" maxlength="8" style="form-control" id="1_esn"></td>
                    </tr>
                    <tr>
                        <td>Auth Key</td>
                        <td> <input type="text" placeholder="Auth Key" maxlength="37" style="form-control" id="1_auth_key"></td>
                    </tr>
                    <tr>
                        <td>Resources</td>
                        <td>This demo is subscribing to video recording start (<a href="https://apidocs.eagleeyenetworks.com/apidocs/#event-objects">VRES</a>) and video recording end (<a href="https://apidocs.eagleeyenetworks.com/apidocs/#event-objects">VREE</a>) events.</td>
                    </tr>
                    </tbody>
                </table>
                </p>
            </div>
            <div class="col-4">
				<h4>Websocket Messages</h4>
				<ul id="output_log"></ul>
            </div>
        </div>


        <div class="row">
            <div class="col-11 offset-1">
                <h2>What about CORS?</h2>
            </div>
        </div>
        <div class="row">
            <div class="col-8 offset-1">
                <p>
					Websocket connects are not restricted by CORS in the browser.
                </p>
            </div>
            <div class="col-3">
            </div>
        </div>


        <div class="row">
            <div class="col-11 offset-1">
                <h2>What else can we do with this?</h2>
            </div>
        </div>
        <div class="row">
            <div class="col-9 offset-1">
                <p>
                    I am excited the see the additional applications that can benefit from easily embeddable video.  Not only can the preview stream be worked as a series of JPEG images, video can now be used as just a standard video component.
                </p>
                <p>
                    I hope you found this helpful.  If you have any questions please feel free to reach out to us at api_support@een.com
                </p>

            </div>

        </div>

    </div>

</main>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script src="EEN.MediaPlayer.js"></script>
<script>

    $(document).ready(function() {


		// Start with declairing the basic variables
		account_sub_domain = "c001";
		account_id = "00009673";
		camera_id = "100d93f9";
		auth_key = "c001~33b51ab065e01396c70722e4fd428f5d";


		wsLog = $('#output_log');

		// Build the subscription string
		data = {"cameras": {}};
		data.cameras[camera_id] = {"resource": ["event"], "event": ["VRES", "VREE"]}


		// Build the WebSocket connection URL
		connection_url = [
                        "wss://", 
                        account_sub_domain,
                        ".eagleeyenetworks.com",
                        "/api/v2/Device/",
                        account_id,
                        "/Events?A=",
                        auth_key
                ].join('');


		// make the WebSocket connection
		socket = new WebSocket(connection_url);


		// when the socket opens, register the subscriptions
		socket.addEventListener('open', function(event) {
        		console.log('socket opened');
        		socket.send(JSON.stringify(data));
		});

		// for every message received, parse the data into an object and update the image on the page
		// send an acknowledgement that you are ready for the next image
		socket.addEventListener('message', function(event) {
        		console.log(event.data);
        		json = JSON.parse(event.data);
				vres = json['data'][camera_id]['event']['VRES'];
				vree = json['data'][camera_id]['event']['VREE'];

				//
        		//img = document.getElementById('img')
        		//if(img) {
               // 		img.setAttribute('src', 'data:image/jpeg;base64,' + json.data[camera_id].image.image);  
       			//}

        		//socket.send('{"ack": ' + json.data[camera_id].image.epoch + '}');


				if(vres != undefined) {	
					wsLog.append('<li>Video Start: ' + vres['timestamp'] + '</li>');
				} 
			
				if(vree != undefined) {
					wsLog.append('<li>Video End: ' + vree['timestamp'] + '</li>');
				}


		});

		// handle the close event
		socket.addEventListener('close', function(event) {
        		console.log('socket closed')
		});

		// handle any errors
		socket.addEventListener('error', function(event) {
        		console.log('socket error ', event);
		});


    });


</script>

</body>
</html>

